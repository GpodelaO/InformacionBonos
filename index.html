<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Bonos</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    /* ========== Estilos generales ========== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #eef2f7;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #6241AB;
      margin-top: 20px;
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 2rem;
    }
    .container {
      width: 95%;
      max-width: 1100px;
      margin: 20px auto;
      padding: 20px;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 10px;
    }
    .logo-container img {
      width: 150px;
      height: auto;
    }
    .aviso {
      text-align: center;
      margin: 20px auto;
      background: #fff;
      border: 1px solid #6241AB;
      border-radius: 8px;
      padding: 15px;
      color: #444;
      font-size: 1rem;
      line-height: 1.5;
      max-width: 800px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .aviso:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .input-group-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
      width: 100%;
    }
    .input-group {
      width: 50%;
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="text"],
    button {
      font-size: 1rem;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 100%;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    button {
      background: linear-gradient(135deg, #6241AB, #4e3190);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    button:hover {
      background: linear-gradient(135deg, #4e3190, #6241AB);
      transform: scale(1.03);
    }
    .data-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      min-width: 300px;
      flex: 1 1 300px;
    }
    .card-title {
      text-transform: uppercase;
      margin-bottom: 10px;
      font-size: 1.1rem;
      font-weight: 700;
      color: #6241AB;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .user-data div {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      font-size: 0.95rem;
    }
    .user-data div:last-child {
      border-bottom: none;
    }
    .user-data strong {
      color: #6241AB;
      margin-right: 10px;
    }
    .calculation-section label {
      margin-right: 10px;
      color: #6241AB;
      font-weight: 500;
    }
    .calculation-section div {
      margin-bottom: 15px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      font-size: 0.95rem;
    }
    .calculation-section div:last-child {
      border-bottom: none;
    }
    #pcaCalculada {
      color: #6241AB;
      font-weight: 600;
      margin-left: 15px;
    }
    .calc-result {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    .calc-result label {
      font-weight: 500;
      color: #6241AB;
      margin-right: 5px;
    }
    .calc-result span {
      color: #333;
      font-weight: 600;
    }
    /* Ocultamos completamente el input de persistencia para que el usuario no lo modifique */
    #persistenciaInput {
      display: none;
    }
    .banda-bonus-section {
      width: 100%;
      margin-top: 20px;
      display: none;
    }
    .banda-bonus-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .diferencia {
      background: #fff;
      border-radius: 8px;
      border: 2px solid #6241AB;
      padding: 10px;
      font-size: 1rem;
      line-height: 1.5;
    }
    .diferencia ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .diferencia li {
      margin-bottom: 8px;
      padding: 10px;
      background: #f7f7ff;
      border-radius: 8px;
      border-left: 4px solid #6241AB;
      transition: background 0.3s ease;
    }
    .diferencia li:hover {
      background: #e7e5f9;
    }
    .diferencia li:last-child {
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <!-- LOGO -->
  <div class="logo-container">
    <img src="LOGO.png" alt="Logo" />
  </div>
  <!-- TITULO -->
  <h1>Información De Bonos</h1>

  <!-- AVISO -->
  <div class="aviso">
    La información presentada corresponde a datos consolidados al cierre del mes anterior. <br />
    Los montos mostrados son aproximados y tienen como propósito ofrecer una referencia sobre tu progreso trimestral.
  </div>

  <!-- MAIN CONTAINER -->
  <div class="container">
    <!-- APARTADO PARA BUSCAR USUARIO -->
    <div class="input-group-container">
      <div class="input-group">
        <label for="usuarioInput">Introducir Contraseña:</label>
        <input type="text" id="usuarioInput" placeholder="Ingrese el ID del usuario" />
        <button id="buscarUsuario">Ingresar</button>
      </div>
    </div>

    <div class="data-container">
      <!-- TARJETA DATOS DE USUARIO -->
      <div id="userData" class="user-data card" style="display: none;"></div>

      <!-- TARJETA DE INPUTS Y VALORES -->
      <div class="calculation-section card" id="calculos" style="display: none;">
        <h2 class="card-title">Calculadora De Bono Estimado ($)</h2>

        <div>
          <label for="arrastreInput">Arrastre:</label>
          <input type="text" id="arrastreInput" value="0" />
        </div>
        <div>
          <label for="ventaNuevaInput">Venta Nueva:</label>
          <input type="text" id="ventaNuevaInput" value="0" />
        </div>
        <div>
          <label for="pcaCalculada">PCA Calculada:</label>
          <span id="pcaCalculada">$0.00</span>
        </div>

        <div class="calc-result">
          <label>Banda Estimada:</label>
          <span id="bandaEstimada">--</span>
        </div>
        <div class="calc-result">
          <label>Porcentaje Bono Estimado:</label>
          <span id="porcentajeBonoEstimado">--</span>
        </div>
        <div class="calc-result">
          <label>Bono Estimado:</label>
          <span id="bonoEstimado">--</span>
        </div>

        <!-- Input hidden para persistencia, que se usa internamente en cálculos -->
        <input type="hidden" id="persistenciaInput" value="0" />
      </div>
    </div>

    <!-- SECCIÓN PARA MOSTRAR LA BANDA SIGUIENTE -->
    <div class="banda-bonus-section" id="bandaBonusSection">
      <div class="banda-bonus-container">
        <h3 class="card-title" style="margin-top: 0;">Información Estimada para Alcanzar la Siguiente Banda de Bono</h3>
        <div class="diferencia">
          <ul id="bandasDiferencia"></ul>
        </div>
        <div id="bonusDirectoInfo"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== URL del CSV en Google Sheets ==========
    const googleSheetCSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhZ5SjhMC3cn4xemgNL4j7zsdD2hWWkdhrrwFXrFo6F26kN9GRzh7BfF9f5iRLrqZfTM02GDJ7t1or/pub?output=csv";

    // ========== Arrays de BANDAS 2024 ==========
    const tablaConsolidado2024 = [825000, 725000, 625000, 525000, 462500, 400000, 337500, 275000, 212500, 150000];
    const tablaCrecimiento2024 = [775000, 687000, 612000, 512000, 450000, 387500, 325000, 262500, 200000, 137500];
    const tablaNuevo2024       = [780000, 680000, 580000, 480000, 420000, 360000, 300000, 240000, 180000, 120000];

    // ========== Arrays de BANDAS 2025 (ejemplo) ==========
    const tablaConsolidado2025 = [870000, 760000, 660000, 550000, 485000, 420000, 355000, 290000, 225000, 160000];
    const tablaCrecimiento2025 = [800000, 725000, 645000, 540000, 475000, 410000, 345000, 275000, 210000, 150000];
    const tablaNuevo2025       = [750000, 625000, 500000, 437500, 375000, 312500, 250000, 187500, 125000];

    // ========== Arrays de BONOS 2024 (p81, p86, p91) ==========
    const bonosConsolidado2024 = [
      { minPCA: 825000, p81: 34, p86: 37, p91: 42 },
      { minPCA: 725000, p81: 30, p86: 34, p91: 39 },
      { minPCA: 625000, p81: 24, p86: 28, p91: 33 },
      { minPCA: 525000, p81: 21, p86: 25, p91: 30 },
      { minPCA: 462500, p81: 19, p86: 22, p91: 28 },
      { minPCA: 400000, p81: 17, p86: 19, p91: 25 },
      { minPCA: 337500, p81: 13, p86: 15, p91: 20 },
      { minPCA: 275000, p81: 8,  p86: 13, p91: 17 },
      { minPCA: 212500, p81: 5,  p86: 11, p91: 15 },
      { minPCA: 150000, p81: 2,  p86: 9,  p91: 11 }
    ];
    const bonosCrecimiento2024 = [
      { minPCA: 775000, p81: 36, p86: 39, p91: 44 },
      { minPCA: 687000, p81: 31, p86: 35, p91: 40 },
      { minPCA: 612000, p81: 26, p86: 30, p91: 35 },
      { minPCA: 512000, p81: 22, p86: 26, p91: 32 },
      { minPCA: 450000, p81: 19, p86: 21, p91: 27 },
      { minPCA: 387500, p81: 17, p86: 19, p91: 24 },
      { minPCA: 325000, p81: 15, p86: 16, p91: 22 },
      { minPCA: 262500, p81: 11, p86: 15, p91: 19 },
      { minPCA: 200000, p81: 9,  p86: 12, p91: 17 },
      { minPCA: 137500, p81: 7,  p86: 8,  p91: 13 }
    ];
    const bonosNuevo2024 = [
      { minPCA: 780000, p81: 39, p86: 39, p91: 39 },
      { minPCA: 680000, p81: 37, p86: 37, p91: 37 },
      { minPCA: 580000, p81: 33, p86: 33, p91: 33 },
      { minPCA: 480000, p81: 28, p86: 28, p91: 28 },
      { minPCA: 420000, p81: 26, p86: 26, p91: 26 },
      { minPCA: 360000, p81: 24, p86: 24, p91: 24 },
      { minPCA: 300000, p81: 21, p86: 21, p91: 21 },
      { minPCA: 240000, p81: 19, p86: 19, p91: 19 },
      { minPCA: 180000, p81: 14, p86: 14, p91: 14 },
      { minPCA: 120000, p81: 10, p86: 10, p91: 10 }
    ];

    // ========== Arrays de BONOS 2025 (ejemplo) ==========
    const bonosConsolidado2025 = [
      { minPCA: 870000, p81: 34, p86: 37, p91: 42 },
      { minPCA: 760000, p81: 30, p86: 34, p91: 39 },
      { minPCA: 660000, p81: 24, p86: 28, p91: 33 },
      { minPCA: 550000, p81: 21, p86: 25, p91: 30 },
      { minPCA: 485000, p81: 19, p86: 22, p91: 28 },
      { minPCA: 420000, p81: 17, p86: 19, p91: 25 },
      { minPCA: 355000, p81: 13, p86: 15, p91: 20 },
      { minPCA: 290000, p81: 8,  p86: 13, p91: 17 },
      { minPCA: 225000, p81: 5,  p86: 11, p91: 15 },
      { minPCA: 160000, p81: 2,  p86: 9,  p91: 11 }
    ];
    const bonosCrecimiento2025 = [
      { minPCA: 800000, p85: 34, p88: 37, p91: 42 },
      { minPCA: 725000, p85: 31, p88: 35, p91: 40 },
      { minPCA: 645000, p85: 26, p88: 30, p91: 35 },
      { minPCA: 540000, p85: 22, p88: 26, p91: 32 },
      { minPCA: 475000, p85: 19, p88: 21, p91: 27 },
      { minPCA: 410000, p85: 17, p88: 19, p91: 24 },
      { minPCA: 345000, p85: 15, p88: 17, p91: 22 },
      { minPCA: 275000, p85: 11, p88: 15, p91: 19 },
      { minPCA: 210000, p85: 9,  p88: 12, p91: 17 },
      { minPCA: 150000, p85: 7,  p88: 8,  p91: 13 }
    ];
    const bonosNuevo2025 = [
      { minPCA: 750000, p81: 36, p86: 36, p91: 36 },
      { minPCA: 625000, p81: 32, p86: 32, p91: 32 },
      { minPCA: 500000, p81: 28, p86: 28, p91: 28 },
      { minPCA: 437500, p81: 26, p86: 26, p91: 26 },
      { minPCA: 375000, p81: 24, p86: 24, p91: 24 },
      { minPCA: 312500, p81: 21, p86: 21, p91: 21 },
      { minPCA: 250000, p81: 19, p86: 19, p91: 19 },
      { minPCA: 187500, p81: 14, p86: 14, p91: 14 },
      { minPCA: 125000, p81: 10, p86: 10, p91: 10 }
    ];

    // ========== Variables globales ==========
    let rows = [];

    const buscarUsuarioBtn    = document.getElementById("buscarUsuario");
    const usuarioInput        = document.getElementById("usuarioInput");
    const userDataDiv         = document.getElementById("userData");
    const arrastreInput       = document.getElementById("arrastreInput");
    const ventaNuevaInput     = document.getElementById("ventaNuevaInput");
    const persistenciaInput   = document.getElementById("persistenciaInput"); // hidden
    const pcaCalculadaDiv     = document.getElementById("pcaCalculada");

    const bandaEstimadaSpan          = document.getElementById("bandaEstimada");
    const porcentajeBonoEstimadoSpan = document.getElementById("porcentajeBonoEstimado");
    const bonoEstimadoSpan           = document.getElementById("bonoEstimado");

    const bandasDiferenciaUl  = document.getElementById("bandasDiferencia");
    const bandaBonusSection   = document.getElementById("bandaBonusSection");
    const bonusDirectoInfoDiv = document.getElementById("bonusDirectoInfo");

    // Al cargar, leemos la hoja
    document.addEventListener("DOMContentLoaded", () => {
      Papa.parse(googleSheetCSV_URL, {
        download: true,
        header: true,
        complete: (results) => {
          rows = results.data;
          console.log("Datos cargados:", rows.length, "filas.");
        },
        error: (err) => {
          alert("Error al leer la hoja de Google Sheets: " + err);
        }
      });

      // Pequeño formateo en blur
      arrastreInput.addEventListener("blur", () => {
        arrastreInput.value = formatCurrencyNumberOnly(arrastreInput.value);
      });
      ventaNuevaInput.addEventListener("blur", () => {
        ventaNuevaInput.value = formatCurrencyNumberOnly(ventaNuevaInput.value);
      });
    });

    buscarUsuarioBtn.addEventListener("click", () => {
      const usuario = usuarioInput.value.trim();
      if (!usuario) {
        alert("Por favor, ingrese un ID de usuario.");
        return;
      }
      if (!rows || rows.length === 0) {
        alert("No hay datos cargados o el CSV está vacío.");
        return;
      }

      // Buscamos la fila cuyo 'Usuario' coincida
      const row = rows.find(r => r["Usuario"] == usuario);
      if (!row) {
        alert("Usuario no encontrado.");
        return;
      }
      mostrarUsuario(row);
    });

    function mostrarUsuario(row) {
      // Obtenemos valores numéricos
      const pca           = parseFloat(row["PCA"] || 0);
      const persistencia  = parseFloat(row["Persistencia"] || 0);
      const porcentaje    = parseFloat(row["Porcentaje De Bono (%)"] || 0);
      const bono          = parseFloat(row["Bono"] || 0);
      const adelanto      = parseFloat(row["Adelanto"] || 0);
      const bononeto      = parseFloat(row["Bono Neto"] || 0);
      const bonoPersist   = parseFloat(row["Bono Persistencia"] || 0);
      // const cuaderno      = row["Cuaderno"] || "2024"; // Lo usamos internamente

      userDataDiv.style.display = "block";
      userDataDiv.innerHTML = `
        <h2 class="card-title">Información Trimestral de Agente</h2>
      `;

      // Mostramos la persistencia (%) en la tarjeta,
      // PERO NO mostrarmos "Usuario" ni "Cuaderno"
      const fields = [
        { label: "Nombre",             value: row["Nombre"] || "" },
        { label: "Tipo de Agente",     value: row["Tipo de Agente"] || "" },
        { label: "PCA",                value: formatCurrency(pca) },
        { label: "Persistencia (%)",   value: persistencia.toFixed(2) + "%" },
        { label: "Porcentaje De Bono", value: porcentaje.toFixed(2) + "%" },
        { label: "Bono",               value: formatCurrency(bono) },
        { label: "Adelanto",           value: formatCurrency(adelanto) },
        { label: "Bono Neto",          value: formatCurrency(bononeto) },
        { label: "Bono Persistencia",  value: formatPercent(bonoPersist) }
      ];

      fields.forEach(field => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${field.label}:</strong><span>${field.value}</span>`;
        userDataDiv.appendChild(div);
      });

      // Guardamos la persistencia en el input oculto
      persistenciaInput.value = persistencia.toFixed(2);

      // Mostramos la sección de cálculos
      document.getElementById("calculos").style.display = "block";
      bandaBonusSection.style.display = "none";

      // Determinamos el tipo de agente y cuaderno (usado para elegir tablas):
      const tipoAgente  = (row["Tipo de Agente"] || "").toLowerCase();
      const anioCuaderno = row["Cuaderno"] || "2024"; // por defecto, 2024

      // Escuchamos cambios en arrastre/ventaNueva
      [arrastreInput, ventaNuevaInput].forEach(input => {
        input.addEventListener("input", () => {
          calcularPCA(pca, tipoAgente, anioCuaderno);
        });
      });

      // Cálculo inicial
      calcularPCA(pca, tipoAgente, anioCuaderno);
    }

    function calcularPCA(pcaBase, tipoAgente, anioCuaderno) {
      const arrastre     = parseFloat(cleanCurrency(arrastreInput.value)) || 0;
      const ventaNueva   = parseFloat(cleanCurrency(ventaNuevaInput.value)) || 0;
      const persistencia = parseFloat(persistenciaInput.value || 0);

      const pcaCalculada = pcaBase + arrastre + ventaNueva;
      pcaCalculadaDiv.textContent = formatCurrency(pcaCalculada);

      // Seleccionamos las bandas según cuaderno y tipo
      let bandas = [];
      if (anioCuaderno === "2024") {
        if (tipoAgente === "consolidado") bandas = tablaConsolidado2024;
        else if (tipoAgente === "crecimiento") bandas = tablaCrecimiento2024;
        else if (tipoAgente === "nuevo") bandas = tablaNuevo2024;
      } else {
        if (tipoAgente === "consolidado") bandas = tablaConsolidado2025;
        else if (tipoAgente === "crecimiento") bandas = tablaCrecimiento2025;
        else if (tipoAgente === "nuevo") bandas = tablaNuevo2025;
      }

      if (!bandas || bandas.length === 0) {
        bandasDiferenciaUl.innerHTML = "<li>No hay bandas disponibles</li>";
        bandaBonusSection.style.display = "block";
        return;
      }

      // Calculamos la siguiente banda
      let bandaMasCercana = null;
      let diferenciaMinima = Infinity;
      for (let banda of bandas) {
        const diff = banda - pcaCalculada;
        if (diff > 0 && diff < diferenciaMinima) {
          diferenciaMinima = diff;
          bandaMasCercana  = banda;
        }
      }

      let html = "";
      if (bandaMasCercana) {
        html += `
          <li>
            <strong>Producción Faltante Para la Siguiente Banda:</strong>
            ${formatCurrency(diferenciaMinima)}
            <br/>
            <strong>Próxima Banda:</strong>
            ${formatCurrency(bandaMasCercana)}
          </li>
        `;
        // Array de bonos
        let arrayBonos = [];
        if (anioCuaderno === "2024") {
          if (tipoAgente === "consolidado") arrayBonos = bonosConsolidado2024;
          else if (tipoAgente === "crecimiento") arrayBonos = bonosCrecimiento2024;
          else if (tipoAgente === "nuevo") arrayBonos = bonosNuevo2024;
        } else {
          if (tipoAgente === "consolidado") arrayBonos = bonosConsolidado2025;
          else if (tipoAgente === "crecimiento") arrayBonos = bonosCrecimiento2025;
          else if (tipoAgente === "nuevo") arrayBonos = bonosNuevo2025;
        }

        let filaBanda = arrayBonos.find(b => b.minPCA === bandaMasCercana);
        if (!filaBanda) filaBanda = arrayBonos[0];

        // Persistencia -> % Siguiente Banda
        let porcentajeSiguienteBanda = 0;
        if (persistencia >= 91) {
          porcentajeSiguienteBanda = filaBanda.p91;
        } else if (persistencia >= 86) {
          porcentajeSiguienteBanda = filaBanda.p86;
        } else if (persistencia >= 81) {
          porcentajeSiguienteBanda = filaBanda.p81;
        }

        const bonoSig = bandaMasCercana * (porcentajeSiguienteBanda / 100);
        html += `
          <li>
            <strong>Bono Calculado en la Siguiente Banda:</strong>
            ${formatCurrency(bonoSig)}
          </li>
        `;
        const bonoEstimadoActual = parseFloat(cleanCurrency(bonoEstimadoSpan.textContent)) || 0;
        const adicional = bonoSig - bonoEstimadoActual;
        html += `
          <li>
            <strong>Adicional Estarías Ganando:</strong>
            ${formatCurrency(adicional)}
          </li>
        `;
      } else {
        html += `
          <li>
            <strong>Banda Más Cercana:</strong>
            ¡Felicidades! Has superado la banda más alta.
          </li>
        `;
      }
      bandasDiferenciaUl.innerHTML = html;
      bandaBonusSection.style.display = "block";

      // Calculamos el bono principal
      calcularBonoDirecto(pcaCalculada, tipoAgente, anioCuaderno);

      // Calculamos persistencia si es consolidado
      calcularBonoPersistenciaAuto(pcaCalculada, persistencia, tipoAgente, anioCuaderno);
    }

    function calcularBonoDirecto(pcaCalculada, tipoAgente, anioCuaderno) {
      const persistencia = parseFloat(persistenciaInput.value) || 0;
      bonusDirectoInfoDiv.innerHTML = "";

      if (!persistencia || persistencia < 0) {
        bandaEstimadaSpan.textContent          = "--";
        porcentajeBonoEstimadoSpan.textContent = "--";
        bonoEstimadoSpan.textContent           = "--";
        bonusDirectoInfoDiv.innerHTML = `
          <p>Ingrese un valor de Persistencia válido para calcular el Bono Directo.</p>
        `;
        return;
      }

      // Array de bonos
      let arrayBonos = [];
      if (anioCuaderno === "2024") {
        if (tipoAgente === "consolidado") arrayBonos = bonosConsolidado2024;
        else if (tipoAgente === "crecimiento") arrayBonos = bonosCrecimiento2024;
        else if (tipoAgente === "nuevo") arrayBonos = bonosNuevo2024;
      } else {
        if (tipoAgente === "consolidado") arrayBonos = bonosConsolidado2025;
        else if (tipoAgente === "crecimiento") arrayBonos = bonosCrecimiento2025;
        else if (tipoAgente === "nuevo") arrayBonos = bonosNuevo2025;
      }

      let filaSeleccionada = null;
      for (let item of arrayBonos) {
        if (pcaCalculada >= item.minPCA) {
          filaSeleccionada = item;
          break;
        }
      }
      if (!filaSeleccionada) {
        bandaEstimadaSpan.textContent          = "--";
        porcentajeBonoEstimadoSpan.textContent = "0%";
        bonoEstimadoSpan.textContent           = formatCurrency(0);
        bonusDirectoInfoDiv.innerHTML = `
          <p>La PCA Calculada <strong>no alcanza la banda mínima</strong>.</p>
          <p><strong>Porcentaje Directo:</strong> 0%</p>
          <p><strong>Bono Directo Calculado:</strong> $0.00</p>
        `;
        return;
      }

      let porcentajeBono = 0;
      if (persistencia >= 91) {
        porcentajeBono = filaSeleccionada.p91;
      } else if (persistencia >= 86) {
        porcentajeBono = filaSeleccionada.p86;
      } else if (persistencia >= 81) {
        porcentajeBono = filaSeleccionada.p81;
      }
      const bonoCalculado = (pcaCalculada * porcentajeBono) / 100;
      bandaEstimadaSpan.textContent          = "Desde " + formatCurrency(filaSeleccionada.minPCA);
      porcentajeBonoEstimadoSpan.textContent = porcentajeBono + " %";
      bonoEstimadoSpan.textContent           = formatCurrency(bonoCalculado);
    }

    function calcularBonoPersistenciaAuto(pca, persistencia, tipoAgente, anioCuaderno) {
      if (tipoAgente !== "consolidado") {
        bandasDiferenciaUl.innerHTML += `
          <li>
            <strong>Porcentaje Bono Persistencia:</strong>
            No aplica (solo para Agentes Consolidados).
          </li>
        `;
        return;
      }

      // Lógica 2024 vs 2025, según tu preferencia
      let bandaPersist = [0,0,0];
      if (anioCuaderno === "2024") {
        if (pca >= 825000) {
          bandaPersist = [14, 17, 19];
        } else if (pca >= 725000) {
          bandaPersist = [10, 12, 14];
        } else if (pca >= 625000) {
          bandaPersist = [8, 10, 12];
        } else if (pca >= 525000) {
          bandaPersist = [7, 9, 10];
        } else if (pca >= 462500) {
          bandaPersist = [5, 6, 8];
        } else if (pca >= 400000) {
          bandaPersist = [3, 4, 6];
        } else if (pca >= 337500) {
          bandaPersist = [2, 3, 4];
        } else if (pca >= 275000) {
          bandaPersist = [1, 2, 3];
        } else if (pca >= 212500) {
          bandaPersist = [0, 1, 2];
        } else if (pca >= 150000) {
          bandaPersist = [0, 0, 1];
        }
      } else {
        // Ejemplo 2025
        if (pca >= 870000) {
          bandaPersist = [14, 17, 19];
        } else if (pca >= 760000) {
          bandaPersist = [10, 12, 14];
        } else if (pca >= 660000) {
          bandaPersist = [8, 10, 12];
        } else if (pca >= 550000) {
          bandaPersist = [7, 9, 10];
        } else if (pca >= 485000) {
          bandaPersist = [5, 6, 8];
        } else if (pca >= 420000) {
          bandaPersist = [3, 4, 6];
        } else if (pca >= 355000) {
          bandaPersist = [2, 3, 4];
        } else if (pca >= 290000) {
          bandaPersist = [1, 2, 3];
        } else if (pca >= 225000) {
          bandaPersist = [0, 1, 2];
        } else if (pca >= 160000) {
          bandaPersist = [0, 0, 1];
        }
      }

      let indice = -1;
      if (persistencia >= 91) {
        indice = 2;
      } else if (persistencia >= 86) {
        indice = 1;
      } else if (persistencia >= 81) {
        indice = 0;
      } else {
        bandasDiferenciaUl.innerHTML += `
          <li>
            <strong>No alcanzas el mínimo (81%) de persistencia.</strong>
            Bono Persistencia = 0%
          </li>
        `;
        return;
      }

      const bono = bandaPersist[indice] || 0;
      bandasDiferenciaUl.innerHTML += `
        <li>
          <strong>Porcentaje Bono Persistencia:</strong>
          ${bono}%
        </li>
      `;
    }

    // ======= Helpers =======
    function formatPercent(value) {
      return value.toFixed(2) + "%";
    }
    function formatCurrencyNumberOnly(valueString) {
      let numericValue = valueString.replace(/[^\d.]/g, "");
      if (!numericValue) numericValue = "0";
      const num = parseFloat(numericValue) || 0;
      return formatCurrency(num);
    }
    function cleanCurrency(str) {
      return str.replace(/[^0-9.-]/g, "");
    }
    function formatCurrency(value) {
      return new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN"
      }).format(value);
    }
  </script>
</body>
</html>
